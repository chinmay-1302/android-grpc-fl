## GRPC Demo (Android, Kotlin)

### Overview

This is a minimal Android app demonstrating gRPC on Android with Kotlin and Jetpack Compose. The project includes a Protobuf/gRPC toolchain wired into Gradle so client stubs are generated automatically at build time. A `proto` definition for an edge inference service is included.

### Tech stack

- **Language**: Kotlin
- **UI**: Jetpack Compose
- **Android Gradle Plugin**: 8.13.0
- **Kotlin**: 2.0.21
- **Protobuf Gradle plugin**: 0.9.5
- **protoc**: 3.21.9
- **gRPC Java**: 1.63.0 (okhttp transport, protobuf, stub)
- **gRPC Kotlin**: 1.4.1 (Kotlin coroutine-friendly stubs)
- **Protobuf runtime**: `protobuf-java:3.25.3` and optional `protobuf-kotlin:3.25.3`

### Project structure

- `app/src/main/proto/flotilla.proto`: Service and message definitions
- Generated sources (after build):
  - Java/Kotlin stubs under `app/build/generated/` and `app/build/extracted-*/`
- Gradle config for codegen: `app/build.gradle.kts`

### Proto API (flotilla)

Service `EdgeService` provides:

- `Echo(EchoMessage) -> EchoMessage`: Simple echo for connectivity/testing
- `SendLeNetModel(LeNetModelRequest) -> LeNetModelResponse`: Retrieve model bytes/metadata
- `RunInference(InferenceRequest) -> InferenceResponse`: Send input tensor and receive predictions

Messages (selected):

- `EchoMessage { string text }`
- `LeNetModelRequest { string request_id, string model_type }`
- `LeNetModelResponse { string model_name, bytes model_bytes, string model_format, map<string,string> metadata, string status }`
- `InferenceRequest { string request_id, repeated float input_data, repeated int32 input_shape }`
- `InferenceResponse { string request_id, repeated float output_data, repeated int32 output_shape, string status }`

### Prerequisites

- Android Studio (latest Canary/Stable that supports AGP 8.13)
- JDK 11 (toolchain configured by Gradle)
- Internet access to resolve dependencies from Google/Maven Central

### Build and run

1. Open the project in Android Studio.
2. Let Gradle sync. The Protobuf/gRPC plugins will be applied automatically.
3. Build/Run:
   - From IDE: Run the `app` configuration.
   - From CLI:

     ```bash
     ./gradlew :app:assembleDebug
     ```

   Codegen tasks (e.g., `generateDebugProto`) are wired into the build; no manual steps are required.

### gRPC/Protobuf codegen details

- Protobuf plugin configured in `app/build.gradle.kts`:
  - `protoc: 3.21.9`
  - Plugins: `protoc-gen-grpc-java:1.50.2`, `protoc-gen-grpc-kotlin:1.3.0:jdk8`
- Runtime dependencies used by the app at compile/runtime:
  - `io.grpc:grpc-okhttp:1.63.0`
  - `io.grpc:grpc-protobuf:1.63.0`
  - `io.grpc:grpc-stub:1.63.0`
  - `io.grpc:grpc-kotlin-stub:1.4.1`
  - `com.google.protobuf:protobuf-java:3.25.3`
  - `com.google.protobuf:protobuf-kotlin:3.25.3` (optional conveniences)

Generated code locations (after build):

- `app/build/generated/source/proto/` (variant-specific)
- `app/build/extracted-include-protos/` and `app/build/extracted-protos/` (toolchain internals)

### Example: Creating a gRPC client (Android)

If you have a server reachable at `https://example.com:443` (TLS) or `http://10.0.2.2:50051` (plaintext, emulator), you can create a channel and stub like this:

```kotlin
import io.grpc.ManagedChannel
import io.grpc.ManagedChannelBuilder
import io.grpc.okhttp.OkHttpChannelBuilder
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.withContext
import flotilla.EdgeServiceGrpc
import flotilla.EchoMessage

// Kotlin coroutine stub (generated by grpc-kotlin)
import flotilla.EdgeServiceGrpcKt

suspend fun echoOnce(baseUrl: String, plaintext: Boolean = true): String = withContext(Dispatchers.IO) {
    val channel: ManagedChannel = if (plaintext) {
        OkHttpChannelBuilder.forTarget(baseUrl).usePlaintext().build()
    } else {
        OkHttpChannelBuilder.forTarget(baseUrl).build()
    }

    try {
        val stub = EdgeServiceGrpcKt.EdgeServiceCoroutineStub(channel)
        val response = stub.echo(EchoMessage.newBuilder().setText("hello").build())
        response.text
    } finally {
        channel.shutdownNow()
    }
}
```

Notes:

- Use `OkHttpChannelBuilder` for Android.
- Prefer the coroutine stub `EdgeServiceGrpcKt.EdgeServiceCoroutineStub` for idiomatic Kotlin.

### Development workflow

1. Edit `app/src/main/proto/flotilla.proto` to change the API.
2. Rebuild the project. Stubs are regenerated automatically.
3. Call the generated stubs from your Compose UI / ViewModel layer.

Breaking changes in proto will regenerate classes with new/removed fields; ensure callers are updated accordingly.

### Roadmap (implementation tasks)

1. Create a demo gRPC Echo test client and UI hook-up
2. Implement Receive Model service client (request LeNet, handle `model_bytes`)
3. Implement Send Model Weights service client (as defined in proto)
4. Add benchmarking harness and publish baseline results

### Benchmarking plan

- Client-side latency (per-RPC) via interceptors and timestamps
- Throughput under load (batched requests) on different devices
- Payload size sensitivity (e.g., model bytes vs. small messages)
- Use Android Benchmark libraries (Macrobenchmark/Microbenchmark) for repeatable measurements

### Troubleshooting

- Version mismatches between `protoc` plugins and runtime can cause `NoSuchMethodError`/`ClassNotFoundException`. This project pins protoc to 3.21.9 and runtime to 3.25.3 which are compatible.
- If codegen outputs are missing, run a clean build:

  ```bash
  ./gradlew clean :app:assembleDebug
  ```

- On emulator, use `10.0.2.2` to reach host machine. Enable `usePlaintext()` only for local, non-TLS testing.
